<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Europress Parser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400&display=swap" rel="stylesheet">
  <link href="{{ url_for('static', path='/dropzone.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', path='/basic.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', path='/dropzone.min.js') }}"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      background-color: #91d1df;
    }

    #wrapper {
      width: 50%;
      margin: auto;
    }

    #myDropzone {
      min-height: 150px;
      border: 3.5px dashed rgb(0 0 0 / 30%);
      background: #fff;
      padding: 20px 20px;
      border-radius: 2.5rem;
    }

    .myButton {
      padding: 0.5em;
      border-radius: 0.5em;
      margin: 1em;
      margin-left: auto;
      display: block;
      margin-right: auto;
      border: solid 0.1px grey;
    }

    .myButton:hover{
      cursor: pointer;
      background-color: #cbf5ff;
    }
  </style>
</head>

<body>
  <div style="width: 30%;margin: auto; text-align: center">
    <h1 style="font-weight: 100">Europress Converter</h1>
    <h5 style="font-weight: 400">Convert Europress HTML Files to some text analysis formats</h5>
  </div>
  <!-- <form action="/upload" class="dropzone" id="my-great-dropzone"> -->
  <div id="wrapper">
    <form method="post" enctype="multipart/form-data" action="/upload" id="myForm">
      <div class="dropzone" id="myDropzone"></div>
      <select class="myButton" name="output" id="output">
        <option value="iramuteq">IramuTeq</option>
        <option value="pivot">Pivot</option>
        <option value="cluster_tool">Cluster Tool</option>
      </select>
    </form>
    <div>
      <button class="myButton" type="submit" id="submit-all"> upload </button>
    </div>
  </div>
  <script>
    function saveBlob(blob, fileName) {
      var a = document.createElement('a');
      a.href = window.URL.createObjectURL(blob);
      a.download = fileName;
      a.dispatchEvent(new MouseEvent('click'));
    }

    Dropzone.options.myDropzone = {
      paramName: 'files',
      url: '/upload',
      autoProcessQueue: false,
      uploadMultiple: true,
      parallelUploads: 100,
      maxFiles: 100,
      // addRemoveLinks: true,
      // headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
      init: function () {
        dzClosure = this; // Makes sure that 'this' is understood inside the functions below.

        // for Dropzone to process the queue (instead of default form behavior):
        document.getElementById("submit-all").addEventListener("click", function (e) {
          // Make sure that the form isn't actually being sent.
          e.preventDefault();
          e.stopPropagation();
          dzClosure.processQueue();
        });

        //send all the form data along with the files:
        this.on("sendingmultiple", function (data, xhr, formData) {
          formData.append("output", document.getElementById('output').value);
          for (let el of data) {
            let blob = new Blob([el], { type: el.type });
            formData.append("files", blob, el.name)
          }
          xhr.responseType = 'blob';
          xhr.onload = function (e) {
            var blob = e.currentTarget.response;
            var contentDispo = e.currentTarget.getResponseHeader('Content-Disposition');
            // https://stackoverflow.com/a/23054920/
            var fileName = contentDispo.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/)[1];
            saveBlob(blob, fileName);
          }
          xhr.send(formData)
        });
      }
    }
  </script>
</body>

</html>